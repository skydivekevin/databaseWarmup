'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.default = startProcess;
exports.startCommand = startCommand;

var _path = require('path');

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _crossSpawn = require('cross-spawn');

var _livereload = require('./livereload');

var _livereload2 = _interopRequireDefault(_livereload);

var _config = require('./config');

var _config2 = _interopRequireDefault(_config);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable unicorn/no-process-exit */

/**
 * Spawn child process with a server
 *
 * @returns {ChildProcess}
 */
function startProcess(_ref) {
	var debug = _ref.debug;

	var bin = (0, _path.join)(__dirname, '../../bin/start-server');
	var args = [bin];
	if (debug) {
		args.unshift('--inspect-brk=0.0.0.0:' + (_config2.default.debugPort || 5858));
	}
	var proc = (0, _crossSpawn.spawn)('node', args, {
		stdio: ['inherit', 'inherit', 'inherit', 'ipc'], // IPC to know when server is done spinning up
		customFds: [0, 1, 2]
	});

	proc.on('close', function (code, signal) {
		if (code !== null) {
			if (code === 0) {
				process.exit(0);
			} else {
				console.error(_chalk2.default.bgRed.black(' ERROR '), _chalk2.default.red('Server process crashed. Waiting for changes...'));
				console.log(_chalk2.default.gray("There's likely an additional logging output above"));
			}
		}
		if (signal) {
			if (signal === 'SIGKILL') {
				process.exit(137);
			}
			console.log(_chalk2.default.bgGray.black(' SIG '), 'Got signal ' + signal + ', exiting');
			process.exit(1);
		}
	});

	proc.on('error', function (err) {
		console.error(_chalk2.default.bgRed.black(' ERROR '), _chalk2.default.red.bold(err));
	});

	proc.on('message', function (message) {
		if (message === 'EXPRESSX:READY') {
			(0, _livereload2.default)(); // Refresh when server is done spinning up
		}
	});

	return proc;
}

function startCommand(cli) {
	if (_fsExtra2.default.existsSync((0, _path.join)(process.cwd(), '.expressx/build/app.js'))) {
		startProcess({
			debug: cli.parent.debug
		});
	} else {
		console.log();
		console.error(_chalk2.default.bgRed.black(' ERROR '), _chalk2.default.red('Build not found'));
		console.log();
		console.log('Did you forget to run "' + _chalk2.default.bold('expressx build') + '"?');
		console.log();
		process.exit(1);
	}
}